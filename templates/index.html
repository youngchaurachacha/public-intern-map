<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>공공인턴지도</title>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Malgun Gothic', '맑은 고딕', sans-serif;
            /* user-select 순서 수정 (호환성) */
            -webkit-user-select: none; /* 구버전 브라우저용 */
            user-select: none;         /* 최신 표준 */
        }
        #map {
            width: 100%;
            height: 100%;
        }
        #loader {
            position: absolute;
            left: 50%;
            top: 50%;
            z-index: 10;
            width: 120px;
            height: 120px;
            margin: -76px 0 0 -76px;
            border: 16px solid #f3f3f3;
            border-radius: 50%;
            border-top: 16px solid #3498db;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<div id="map"></div>
<div id="loader"></div>

<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_api_key }}&libraries=services&v=1"></script>

<script>
const mapContainer = document.getElementById('map');
const mapOption = { 
    center: new kakao.maps.LatLng(36.5, 127.5),
    level: 12
};
const map = new kakao.maps.Map(mapContainer, mapOption);
const loader = document.getElementById('loader');

const infowindow = new kakao.maps.InfoWindow({
    zIndex: 1,
    removable: true // 인포윈도우를 닫을 수 있는 x 버튼 추가
});

fetch('/api/postings')
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        loader.style.display = 'none';

        if (!data || data.length === 0) {
            console.warn("표시할 공고 데이터가 없습니다.");
            return;
        }

        data.forEach(posting => {
            if (posting.latitude && posting.longitude) {
                const marker = new kakao.maps.Marker({
                    map: map,
                    position: new kakao.maps.LatLng(posting.latitude, posting.longitude)
                });

                const content = `
                    <div style="padding:5px; font-size:12px; max-width: 250px; white-space: normal;">
                        <strong>${posting.title}</strong><br>
                        ${posting.organization}<br>
                        <span style="color:gray;">${posting.address}</span>
                    </div>
                `;

                kakao.maps.event.addListener(marker, 'click', function() {
                    infowindow.setContent(content);
                    infowindow.open(map, marker);
                });
            }
        });
    })
    .catch(error => {
        console.error('데이터를 가져오는 중 에러 발생:', error);
        loader.style.display = 'none';
        alert('채용 공고 데이터를 불러오는 데 실패했습니다. 개발자 콘솔을 확인하세요.');
    });
</script>
</body>
</html>